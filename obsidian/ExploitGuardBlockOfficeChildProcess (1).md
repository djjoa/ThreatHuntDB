---
id: fed32a95-bba6-47a6-8519-8d2a2cee97f9
name: ExploitGuardBlockOfficeChildProcess (1)
description: |
  These queries check telemetry from the Exploit Guard rule: Rule: Block Office applications from creating child processes.
  (Rule ID d4f940ab-401b-4efc-aadc-ad5f3c50688a).
  Read more about it here: https://docs.microsoft.com/windows/security/threat-protection/windows-defender-exploit-guard/attack-surface-reduction-exploit-guard.
  Oftentimes organizations enable this rule in audit mode and check the results before setting block mode.
  You can use query #2 to measure the rule impact on your network in audit mode before turning it to block mode.
  Query #1 is used after setting it to block mode - to analyze the block stats.
  Tags: #ASR.
  Query #1: block stats.
requiredDataConnectors:
  - connectorId: MicrosoftThreatProtection
    dataTypes:
      - AlertInfo
      - AlertEvidence
      - DeviceEvents
query: "```kusto\n// These queries check telemetry from the Exploit Guard rule: Rule: Block Office applications from creating child processes\n// (Rule ID d4f940ab-401b-4efc-aadc-ad5f3c50688a)\n// Read more about it here: https://docs.microsoft.com/windows/security/threat-protection/windows-defender-exploit-guard/attack-surface-reduction-exploit-guard\n// Oftentimes organizations enable this rule in audit mode and check the results before setting block mode.\n// You can use query #2 to measure the rule impact on your network in audit mode before turning it to block mode.\n// Query #1 is used after setting it to block mode - to analyze the block stats.\n// Tags: #ASR\n// Query #2: investigate audit events - before turning the rule on in block mode\nlet minTime = ago(7d);\n// Enrich the ExploitGuard events with column saying if there was a nearby Microsoft Defender for Endpoint alert or not.\n// If there was an alert, so this is probably malware, and it's good that it will be blocked.\n// If there was no alert, so it requires further analysis to determine if this is a clean file or some malware that was missed.\nlet alerts =\n    AlertInfo \n    | where Timestamp > minTime\n    | join AlertEvidence on AlertId\n    | project DeviceName, DetectedTimestamp=Timestamp\n;\nDeviceEvents\n| where ActionType == \"AsrOfficeChildProcessAudited\" and Timestamp > minTime\n| project BlockedProcess=FileName, ParentProcess=InitiatingProcessFileName, DeviceName, Timestamp\n| join kind=leftouter (alerts) on DeviceName\n| extend HasNearbyAlert = abs(Timestamp - DetectedTimestamp) between (0min .. 5min)\n| summarize MachineCount=dcount(DeviceName),\n            RuleHits=count(),\n            NearbyAlertPercent=countif(HasNearbyAlert)*100.0 / count() \n            by BlockedProcess, ParentProcess\n| sort by MachineCount desc\n```"
---

