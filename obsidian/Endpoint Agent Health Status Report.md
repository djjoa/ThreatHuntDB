---
id: 64c0f54f-9a8d-4630-95c8-aa2751e5da0c
name: Endpoint Agent Health Status Report
description: |
  This query will provide a report of many of the best practice configurations for Defender ATP deployment. Special Thanks to Gilad Mittelman for the initial inspiration and concept.
  Any tests which are reporting "BAD" as a result imply that the associated capability is not configured per best practice recommendation.
requiredDataConnectors:
  - connectorId: MicrosoftThreatProtection
    dataTypes:
      - DeviceTvmSecureConfigurationAssessment
tactics:
  - Misconfiguration
query: "```kusto\nlet configurationIDs = dynamic([\n    \"scid-2000\", \n    \"scid-2001\", \n    \"scid-5001\", \n    \"scid-6001\", \n    \"scid-2002\", \n    \"scid-5002\", \n    \"scid-6002\", \n    \"scid-2003\", \n    \"scid-5092\", \n    \"scid-2010\", \n    \"scid-2011\", \n    \"scid-5095\", \n    \"scid-6095\", \n    \"scid-2012\", \n    \"scid-5090\", \n    \"scid-6090\", \n    \"scid-91\",\n    \"scid-2013\", \n    \"scid-5091\", \n    \"scid-6091\", \n    \"scid-2014\", \n    \"scid-2016\", \n    \"scid-5094\", \n    \"scid-6094\"\n]);\nDeviceTvmSecureConfigurationAssessment\n| where ConfigurationId in (configurationIDs)\n| extend Test = case(\n    ConfigurationId == \"scid-2000\", \"SensorEnabled\",\n    ConfigurationId == \"scid-2001\", \"SensorDataCollectionWin\", //windows\n    ConfigurationId == \"scid-5001\", \"SensorDataCollectionMac\", //macOS\n    ConfigurationId == \"scid-6001\", \"SensorDataCollectionLin\", //linux\n    ConfigurationId == \"scid-2002\", \"ImpairedCommunicationsWin\", //windows\n    ConfigurationId == \"scid-5002\", \"ImpairedCommunicationsMac\", //macOS\n    ConfigurationId == \"scid-6002\", \"ImpairedCommunicationsLin\", //linux\n    ConfigurationId == \"scid-2003\", \"TamperProtectionWin\", //windows\n    ConfigurationId == \"scid-5092\", \"TamperProtectionMac\", //macOS\n    ConfigurationId == \"scid-2010\", \"AntivirusEnabled\",\n    ConfigurationId == \"scid-2011\", \"AntivirusSignatureVersionWin\", //windows\n    ConfigurationId == \"scid-5095\", \"AntivirusSignatureVersionMac\", //macOS\n    ConfigurationId == \"scid-6095\", \"AntivirusSignatureVersionLin\", //linux\n    ConfigurationId == \"scid-2012\", \"RealtimeProtectionWin\", //windows\n    ConfigurationId == \"scid-5090\", \"RealtimeProtectionMac\", //macOS\n    ConfigurationId == \"scid-6090\", \"RealtimeProtectionLin\", //linux\n    ConfigurationId == \"scid-91\"  , \"BehaviorMonitoring\",\n    ConfigurationId == \"scid-2013\", \"PUAProtectionWin\", // windows\n    ConfigurationId == \"scid-5091\", \"PUAProtectionMac\", //macOS\n    ConfigurationId == \"scid-6091\", \"PUAProtectionLin\", //linux\n    ConfigurationId == \"scid-2014\", \"AntivirusReporting\",\n    ConfigurationId == \"scid-2016\", \"CloudProtectionWin\", //windows\n    ConfigurationId == \"scid-5094\", \"CloudProtectionMac\", //macOS\n    ConfigurationId == \"scid-6094\", \"CloudProtectionLin\", //linux\n    \"N/A\"),\n    Result = case(IsApplicable == 0, \"N/A\", IsCompliant == 1, \"GOOD\", \"BAD\")\n| extend packed = pack(Test, Result)\n| summarize Tests = make_bag(packed), DeviceName = any(DeviceName) by DeviceId, OSPlatform\n| evaluate bag_unpack(Tests)\n| extend CloudProtection = case(\n    OSPlatform startswith \"Windows\", CloudProtectionWin,\n    OSPlatform has \"macOS\",   CloudProtectionMac,\n    OSPlatform has \"Linux\",   CloudProtectionLin,\n    \"NULL\")\n| extend PUAProtection = case(\n    OSPlatform startswith \"Windows\", PUAProtectionWin,\n    OSPlatform has \"macOS\",   PUAProtectionMac,\n    OSPlatform has \"Linux\",   PUAProtectionLin,\n    \"NULL\")\n| extend TamperProtection = case(\n    OSPlatform startswith \"Windows\", TamperProtectionWin,\n    OSPlatform has \"macOS\",   TamperProtectionMac,\n    //OSPlatform has \"Linux\",   TamperProtectionLin,\n    \"NULL\")\n| extend SensorDataCollection = case(\n    OSPlatform startswith \"Windows\", SensorDataCollectionWin,\n    OSPlatform has \"macOS\",   SensorDataCollectionMac,\n    OSPlatform has \"Linux\",   SensorDataCollectionLin,\n    \"NULL\")\n| extend ImpairedCommunications = case(\n    OSPlatform startswith \"Windows\", ImpairedCommunicationsWin,\n    OSPlatform has \"macOS\",   ImpairedCommunicationsMac,\n    OSPlatform has \"Linux\",   ImpairedCommunicationsLin,\n    \"NULL\")\n| extend RealtimeProtection = case(\n    OSPlatform startswith \"Windows\", RealtimeProtectionWin,\n    OSPlatform has \"macOS\",   RealtimeProtectionMac,\n    OSPlatform has \"Linux\",   RealtimeProtectionLin,\n    \"NULL\")\n| extend AntivirusSignatureVersion = case(\n    OSPlatform startswith \"Windows\", AntivirusSignatureVersionWin,\n    OSPlatform has \"macOS\",   AntivirusSignatureVersionMac,\n    OSPlatform has \"Linux\",   AntivirusSignatureVersionLin,\n    \"NULL\")\n| project-away *Win, *Mac, *Lin\n```"
---

