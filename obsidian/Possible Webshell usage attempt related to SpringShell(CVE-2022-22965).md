---
id: 6911d1df-4204-43b2-a64c-3cb102551ddd
name: Possible Webshell usage attempt related to SpringShell(CVE-2022-22965)
description: |
  This query searches Azure Web Application Firewall data for potential Webshell usage related to the SpringShell RCE vulnerability (CVE-2022-22965). For more information refer to Microsoft's security blog.
description-detailed: "'This hunting query looks in Azure Web Application Firewall data to find possible Webshell usage attempts related to SpringShell RCE vulnerability (CVE-2022-22965).\n The Spring Framework is one of the most widely used lightweight open-source framework for Java. The vulnerability in Spring Core can be exploited when an attacker \n sends a specially crafted query to a web server running the Spring Core framework to create a backdoor shell.\n Reference: https://www.microsoft.com/security/blog/2022/04/04/springshell-rce-vulnerability-guidance-for-protecting-against-and-detecting-cve-2022-22965/'\n"
requiredDataConnectors:
  - connectorId: WAF
    dataTypes:
      - AzureDiagnostics
tactics:
  - Execution
relevantTechniques:
  - T1059.007
tags:
  - CVE-2022-22965
  - SpringShell
  - Spring4Shell
query: "```kusto\nlet spring4shellstring = dynamic([\".jsp?pwd=\", \".jsp?cmd=\"]);\nAzureDiagnostics\n| where Category in (\"FrontdoorWebApplicationFirewallLog\", \"FrontdoorAccessLog\", \"ApplicationGatewayFirewallLog\", \"ApplicationGatewayAccessLog\")\n| extend originalRequestUriWithArgs_s = column_ifexists(\"originalRequestUriWithArgs_s\", \"\"), \n   userAgent_s = column_ifexists(\"userAgent_s\", \"\"), \n   clientIP_s = column_ifexists(\"clientIP_s\", \"\"),  \n   clientPort_d = column_ifexists(\"originalRequestUriWithArgs_s\", \"\"),\n   host_s = column_ifexists(\"host_s\", \"\"),\n   requestUri_s = column_ifexists(\"requestUri_s\", \"\"),\n   httpStatus_d = column_ifexists(\"httpStatus_d\",\"\"),\n   listenerName_s = column_ifexists(\"listenerName_s\", \"\"),\n   httpMethod_s = column_ifexists(\"httpMethod_s\", \"\")\n| where httpMethod_s =~ 'GET'\n| where originalRequestUriWithArgs_s has_any (spring4shellstring) or requestUri_s has_any (spring4shellstring)\n| summarize Total = count() by originalRequestUriWithArgs_s, userAgent_s, clientIP_s,clientPort_d, TimeGenerated, host_s, requestUri_s, httpStatus_d,listenerName_s, httpMethod_s, Category\n| extend IPCustomEntity = clientIP_s, timestamp = TimeGenerated, UrlCustomEntity = requestUri_s, HostCustomEntity = host_s\n```"
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: IPCustomEntity
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: UrlCustomEntity
  - entityType: Host
    fieldMappings:
      - identifier: FullName
        columnName: HostCustomEntity
version: 1.0.0
---

